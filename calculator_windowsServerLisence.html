<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows Server 2025 æˆæ¬Šè²»ç”¨è©¦ç®—å·¥å…· (çµ‚æ¥µå®Œå…¨é«”)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; line-height: 1.6; }
        .header { text-align: center; margin-bottom: 20px; color: #0078d4; }
        .container { display: flex; gap: 20px; max-width: 1200px; margin: auto; flex-wrap: wrap; }
        .panel { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); flex: 1; min-width: 450px; }
        .full-width { flex: 100%; min-width: 100%; margin-top: 10px; }
        
        .csv-box { background: #e3f2fd; padding: 15px; border: 2px dashed #90caf9; border-radius: 6px; margin-bottom: 20px; }
        .csv-box h4 { margin-top: 0; color: #1565c0; margin-bottom: 10px;}
        .file-input-group { margin-bottom: 10px; display: flex; align-items: center; gap: 10px;}
        .file-input-group label { width: 120px; font-weight: bold; margin: 0; }
        .btn-import { background: #1565c0; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px;}
        .btn-import:hover { background: #0d47a1; }

        .form-group { margin-bottom: 20px; background: #fff8f0; padding: 15px; border-left: 4px solid #f25022; border-radius: 4px; }
        label { font-weight: bold; display: block; margin-bottom: 8px; }
        input[type="number"] { width: 100px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        
        #hosts-container { margin-top: 20px; }
        .host-block { border: 1px solid #e1dfdd; padding: 15px; margin-bottom: 15px; border-radius: 6px; background: #faf9f8; }
        .host-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; color: #0078d4; }
        .host-title-edit { font-weight: bold; border: none; background: transparent; color: #0078d4; font-size: 16px; width: 250px;}
        .host-inputs { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 14px; font-weight: normal; margin-bottom: 4px; }
        
        /* å±•é–‹æ˜ç´°é¢æ¿æ¨£å¼ */
        .vm-details { margin-top: 15px; border: 1px solid #cfd8dc; border-radius: 4px; background: #fff; overflow: hidden; }
        .vm-details summary { padding: 8px 12px; cursor: pointer; font-weight: bold; color: #1565c0; background: #e3f2fd; outline: none; list-style: none; user-select: none; }
        .vm-details summary::-webkit-details-marker { display: none; }
        .vm-details summary:hover { background: #bbdefb; }
        .details-content { padding: 15px; display: flex; gap: 20px; font-size: 13px; max-height: 250px; overflow-y: auto; background: #fafafa;}
        .list-section { flex: 1; }
        .list-title { font-weight: bold; margin-bottom: 8px; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        .win-title { color: #d13438; border-color: #f8bbd0; }
        .other-title { color: #555; border-color: #e0e0e0; }
        .list-section ul { margin: 0; padding-left: 0; list-style-type: none; }
        .list-section li { margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px dashed #eee; display: flex; flex-direction: column;}
        .vm-name { font-weight: bold; color: #333; }
        .vm-os { color: #777; font-size: 11px; margin-top: 2px;}

        button.btn-primary { background: #0078d4; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button.btn-primary:hover { background: #005a9e; }
        .btn-remove { background: #d13438; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;}
        .btn-remove:hover { background: #a80000; }
        
        .result-box { padding: 15px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ddd; }
        .cost-title { font-size: 15px; color: #333; margin-bottom: 5px; font-weight: bold; }
        .cost-value { font-size: 24px; font-weight: bold; }
        .cost-breakdown { font-size: 13px; color: #666; margin-top: 8px; border-top: 1px dashed #ccc; padding-top: 8px; }
        .winner { background-color: #e8f5e9; border-color: #4caf50; border-width: 2px;}
        .winner .cost-value { color: #2e7d32; }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 30px; }

        .formula-box { background: #f3f2f1; padding: 20px; border-radius: 6px; border-left: 4px solid #0078d4; font-family: 'Consolas', 'Courier New', Courier, monospace; font-size: 14px; }
        .formula-item { margin-bottom: 15px; }
        .host-formula { margin-left: 20px; border-left: 2px solid #ccc; padding-left: 15px; margin-top: 10px; }
        .host-formula div { margin-bottom: 4px; }
        .highlight-calc { background: #e1dfdd; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Windows Server 2025 æˆæ¬Šè²»ç”¨è©¦ç®—å·¥å…· (çµ‚æ¥µå®Œå…¨é«”)</h2>
    </div>

    <div class="container">
        <div class="panel">
            <div class="csv-box">
                <h4>ğŸ“ å¹³å°åŒ¯å…¥ (è‡ªå‹•æ­¸æˆ¶ã€éæ¿¾ OS ä¸¦å±•é–‹æ˜ç´°)</h4>
                <div class="file-input-group">
                    <label>å¯¦é«”ä¸»æ©Ÿ CSVï¼š</label>
                    <input type="file" id="host-csv" accept=".csv">
                </div>
                <div class="file-input-group">
                    <label>VM æ¸…å–® CSVï¼š</label>
                    <input type="file" id="vm-csv" accept=".csv">
                </div>
                <button class="btn-import" onclick="processCSV()">è§£æä¸¦åŒ¯å…¥æ¸…å–®</button>
            </div>

            <h3>ç’°å¢ƒåƒæ•¸è¨­å®š</h3>
            <div class="form-group">
                <label for="total-users">å…¨ç’°å¢ƒä¸é‡è¤‡å­˜å–äººæ•¸ / è¨­å‚™æ•¸ (U<sub>total</sub>)</label>
                <input type="number" id="total-users" value="3000" min="0" oninput="calculateCosts()">
            </div>
            
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">å¯¦é«”ä¸»æ©Ÿèˆ‡ VM é…ç½®</h3>
                <button class="btn-primary" onclick="addHost()">+ æ‰‹å‹•æ–°å¢ä¸»æ©Ÿ</button>
            </div>
            
            <div id="hosts-container"></div>
        </div>

        <div class="panel">
            <h3>è©¦ç®—çµæœåˆ†æ</h3>
            <div id="result-std" class="result-box">
                <div class="cost-title">æ–¹æ¡ˆ Aï¼šStandard (æ¨™æº–ç‰ˆ) ç¸½åƒ¹</div>
                <div class="cost-value" id="cost-std-val">NT$ 0</div>
                <div class="cost-breakdown" id="breakdown-std">ä¼ºæœå™¨æˆæ¬Š: 0 | CAL æˆæ¬Š: 0</div>
            </div>
            
            <div id="result-dc" class="result-box">
                <div class="cost-title">æ–¹æ¡ˆ Bï¼šDatacenter (è³‡æ–™ä¸­å¿ƒç‰ˆ) ç¸½åƒ¹</div>
                <div class="cost-value" id="cost-dc-val">NT$ 0</div>
                <div class="cost-breakdown" id="breakdown-dc">ä¼ºæœå™¨æˆæ¬Š: 0 | CAL æˆæ¬Š: 0</div>
            </div>

            <div class="chart-container">
                <canvas id="costChart"></canvas>
            </div>
        </div>

        <div class="panel full-width">
            <h3>ğŸ§® è²»ç”¨è¨ˆç®—å…¬å¼èˆ‡æ¡è³¼æ˜ç´° (16+2åŒ…è£)</h3>
            <div class="formula-box" id="dynamic-formula-box"></div>
        </div>
    </div>

    <script>
        // å®šåƒ¹å¸¸æ•¸ 
        const P_CAL = 1800; 
        const P_STD_16CORE = 42000; 
        const P_STD_2CORE = 4800;   
        const P_DC_16CORE = 244000; 
        const P_DC_2CORE = 27600;   

        let hostCount = 0;
        let chartInstance = null;

        function initChart() {
            const ctx = document.getElementById('costChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Standard (æ¨™æº–ç‰ˆ)', 'Datacenter (è³‡æ–™ä¸­å¿ƒç‰ˆ)'],
                    datasets: [{ label: 'é ä¼°ç¸½è²»ç”¨ (NT$)', data: [0, 0], backgroundColor: ['#0078d4', '#742774'], borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // ================= CSV è§£æé‚è¼¯ =================
        function processCSV() {
            const hostFile = document.getElementById('host-csv').files[0];
            const vmFile = document.getElementById('vm-csv').files[0];

            if (!hostFile || !vmFile) {
                alert("è«‹åŒæ™‚ä¸Šå‚³ã€Œä¸»æ©Ÿã€èˆ‡ã€ŒVMã€å…©å€‹æª”æ¡ˆï¼"); return;
            }

            Papa.parse(hostFile, {
                header: true, skipEmptyLines: true, transformHeader: h => h.trim(),
                complete: function(hostResults) {
                    Papa.parse(vmFile, {
                        header: true, skipEmptyLines: true, transformHeader: h => h.trim(),
                        complete: function(vmResults) {
                            mapDataToUI(hostResults.data, vmResults.data);
                        }
                    });
                }
            });
        }

        function mapDataToUI(hostsData, vmsData) {
            document.getElementById('hosts-container').innerHTML = ''; 
            hostCount = 0;
            
            // æ•´ç† VM æ¸…å–®ï¼Œåˆ†é¡ Win vs Other
            let hostsMap = {}; 
            vmsData.forEach(vm => {
                let hostIp = (vm['ä¸»æ©Ÿ'] || vm['Host'] || '').trim();
                let os = (vm['å®¢é«”ä½œæ¥­ç³»çµ±'] || vm['Guest OS'] || vm['GuestOS'] || '').trim();
                let vmName = (vm['åç¨±'] || vm['Name'] || vm['VM Name'] || 'æœªå‘½å').trim();
                
                if (!hostIp) return;
                if (!hostsMap[hostIp]) { hostsMap[hostIp] = { winVms: [], otherVms: [] }; }

                let osLower = os.toLowerCase();
                if (osLower.includes('windows') && osLower.includes('server')) {
                    hostsMap[hostIp].winVms.push({ name: vmName, os: os });
                } else {
                    hostsMap[hostIp].otherVms.push({ name: vmName, os: os });
                }
            });

            // åŒ¯å…¥ä¸»æ©Ÿè³‡æ–™ä¸¦å°æ‡‰ VM æ¸…å–®
            hostsData.forEach(host => {
                let hostName = (host['åç¨±'] || host['Name'] || host['Host'] || 'æœªå‘½åä¸»æ©Ÿ').trim();
                // é˜²å‘†ï¼šå°‡å¹³å°åŒ¯å‡ºçš„ CPU è¦–ç‚ºæ ¸å¿ƒæ•¸ï¼Œä¸¦é è¨­ Sockets ç‚º 2
                let cores = parseInt(host['CPU'] || host['Cores']) || 16; 
                let sockets = parseInt(host['Sockets'] || host['å¯¦é«”CPU']) || 2;
                
                let winVms = hostsMap[hostName] ? hostsMap[hostName].winVms : [];
                let otherVms = hostsMap[hostName] ? hostsMap[hostName].otherVms : [];
                
                addHost(hostName, sockets, cores, winVms, otherVms);
            });

            alert("CSV è§£ææˆåŠŸï¼VM æ˜ç´°å·²è‡ªå‹•å±•é–‹ã€‚");
            calculateCosts();
        }

        // ================= UI é‚è¼¯ =================
        function addHost(name = '', cpus = 2, cores = 16, winVms = [], otherVms = []) {
            hostCount++;
            const hostId = `host-${Date.now()}`;
            const displayName = name ? name : `å¯¦é«”ä¸»æ©Ÿ #${hostCount}`;
            const vmCount = name ? winVms.length : 0; 

            // ç”¢ç”Ÿè©³ç´°æ¸…å–® HTML
            let detailsHtml = '';
            if (name && (winVms.length > 0 || otherVms.length > 0)) {
                let winList = winVms.map(v => `<li><span class="vm-name">âœ… ${v.name}</span><span class="vm-os">${v.os}</span></li>`).join('');
                let otherList = otherVms.map(v => `<li><span class="vm-name">ğŸš« ${v.name}</span><span class="vm-os">${v.os}</span></li>`).join('');
                
                detailsHtml = `
                    <details class="vm-details">
                        <summary>ğŸ“‚ å±•é–‹æŸ¥çœ‹è©³ç´° VM æ¸…å–® (éœ€æˆæ¬Š: <span style="color:#d13438;">${winVms.length}</span> / å·²éæ¿¾: <span style="color:#555;">${otherVms.length}</span>)</summary>
                        <div class="details-content">
                            <div class="list-section">
                                <div class="list-title win-title">éœ€æˆæ¬Š Windows Server</div>
                                <ul>${winList || '<li><span class="vm-os">ç„¡</span></li>'}</ul>
                            </div>
                            <div class="list-section">
                                <div class="list-title other-title">å·²éæ¿¾ (å… Windows æˆæ¬Š)</div>
                                <ul>${otherList || '<li><span class="vm-os">ç„¡</span></li>'}</ul>
                            </div>
                        </div>
                    </details>
                `;
            }

            const hostHtml = `
                <div class="host-block" id="${hostId}">
                    <div class="host-header">
                        <input type="text" class="host-title-edit" value="${displayName}">
                        <button class="btn-remove" onclick="removeElement('${hostId}')">åˆªé™¤</button>
                    </div>
                    <div class="host-inputs">
                        <div class="input-group">
                            <label>å¯¦é«” CPU (Sockets)</label>
                            <input type="number" class="cpu-count" value="${cpus}" min="1" oninput="calculateCosts()">
                        </div>
                        <div class="input-group">
                            <label>å¯¦é«”ç¸½æ ¸å¿ƒæ•¸ (Cores)</label>
                            <input type="number" class="core-count" value="${cores}" min="1" oninput="calculateCosts()">
                        </div>
                        <div class="input-group">
                            <label style="color:#d13438; font-weight:bold;">Windows Server VM æ•¸</label>
                            <input type="number" class="vm-count" value="${vmCount}" min="0" oninput="calculateCosts()">
                        </div>
                    </div>
                    ${detailsHtml}
                </div>
            `;
            document.getElementById('hosts-container').insertAdjacentHTML('beforeend', hostHtml);
            if(!name) calculateCosts(); 
        }

        function removeElement(elementId) {
            document.getElementById(elementId).remove();
            calculateCosts();
        }

        // ================= æ ¸å¿ƒè¨ˆç®—é‚è¼¯ (16+2 åŒ…è£) =================
        function calculateCosts() {
            const totalUsers = parseInt(document.getElementById('total-users').value) || 0;
            const hosts = document.querySelectorAll('.host-block');
            
            let totalStdServerCost = 0;
            let totalDcServerCost = 0;
            const calCost = totalUsers * P_CAL;

            let formulaHtml = `
                <div class="formula-item">
                    <strong>1. CAL é€£ç·šæˆæ¬Šè²»ç”¨ï¼š</strong><br>
                    ${totalUsers} (äºº/è¨­å‚™) Ã— NT$ ${P_CAL.toLocaleString()} = <span class="highlight-calc">NT$ ${calCost.toLocaleString()}</span>
                </div>
                <div class="formula-item">
                    <strong>2. ä¼ºæœå™¨æ ¸å¿ƒæˆæ¬Šè²»ç”¨ (æŒ‰æœ€ä½³æ¡è³¼åŒ…è£)ï¼š</strong>
            `;

            hosts.forEach(host => {
                const hostName = host.querySelector('.host-title-edit').value;
                const cpus = parseInt(host.querySelector('.cpu-count').value) || 0;
                const cores = parseInt(host.querySelector('.core-count').value) || 0;
                const vms = parseInt(host.querySelector('.vm-count').value) || 0;

                let requiredCores = Math.max(16, cores, cpus * 8);
                
                let pack16Count = Math.floor(requiredCores / 16);
                let remainderCores = requiredCores % 16;
                let pack2Count = Math.ceil(remainderCores / 2);

                let stdMultiplier = vms > 0 ? Math.ceil(vms / 2) : 1;
                
                let baseCostDC = (pack16Count * P_DC_16CORE) + (pack2Count * P_DC_2CORE);
                let baseCostStd = (pack16Count * P_STD_16CORE) + (pack2Count * P_STD_2CORE);

                let hostDcCost = baseCostDC;
                let hostStdCost = baseCostStd * stdMultiplier;

                totalDcServerCost += hostDcCost;
                totalStdServerCost += hostStdCost;

                formulaHtml += `
                    <div class="host-formula">
                        <strong style="color:#333;">${hostName}</strong>
                        <div>â€¢ åŸºæœ¬éœ€æ±‚ = Max(16, ${cores}æ ¸, ${cpus}é¡†CPUÃ—8) = <strong>${requiredCores} æ ¸å¿ƒ</strong></div>
                        <div>â€¢ æœ€ä½³åŒ…è£ = <strong>${pack16Count} å¥—</strong> 16æ ¸å¿ƒåŒ… + <strong>${pack2Count} å¥—</strong> 2æ ¸å¿ƒåŒ…</div>
                        <div style="margin-top: 8px; color: #742774;">â–¶ Datacenter = NT$ ${baseCostDC.toLocaleString()} </div>
                        <div style="color: #0078d4;">â–¶ Standard = NT$ ${baseCostStd.toLocaleString()} Ã— ç–ŠåŠ  âŒˆ${vms}å°VM Ã· 2âŒ‰ = <strong>NT$ ${hostStdCost.toLocaleString()}</strong></div>
                    </div>
                `;
            });

            formulaHtml += `</div><hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">`;

            const totalStdCost = totalStdServerCost + calCost;
            const totalDcCost = totalDcServerCost + calCost;

            formulaHtml += `
                <div class="formula-item">
                    <strong style="color: #742774;">ğŸ“Œ æ–¹æ¡ˆ Bï¼šDatacenter ç¸½æˆæœ¬ = <span class="highlight-calc" style="color: #742774;">NT$ ${totalDcCost.toLocaleString()}</span></strong>
                </div>
                <div class="formula-item">
                    <strong style="color: #0078d4;">ğŸ“Œ æ–¹æ¡ˆ Aï¼šStandard ç¸½æˆæœ¬ = <span class="highlight-calc" style="color: #0078d4;">NT$ ${totalStdCost.toLocaleString()}</span></strong>
                </div>
            `;

            document.getElementById('dynamic-formula-box').innerHTML = formulaHtml;

            document.getElementById('cost-std-val').innerText = `NT$ ${totalStdCost.toLocaleString()}`;
            document.getElementById('breakdown-std').innerText = `ä¼ºæœå™¨æˆæ¬Š: NT$ ${totalStdServerCost.toLocaleString()} | CAL æˆæ¬Š: NT$ ${calCost.toLocaleString()}`;
            
            document.getElementById('cost-dc-val').innerText = `NT$ ${totalDcCost.toLocaleString()}`;
            document.getElementById('breakdown-dc').innerText = `ä¼ºæœå™¨æˆæ¬Š: NT$ ${totalDcServerCost.toLocaleString()} | CAL æˆæ¬Š: NT$ ${calCost.toLocaleString()}`;

            document.getElementById('result-std').classList.remove('winner');
            document.getElementById('result-dc').classList.remove('winner');
            
            if (hosts.length > 0 || totalUsers > 0) {
                if (totalStdCost <= totalDcCost) document.getElementById('result-std').classList.add('winner');
                else document.getElementById('result-dc').classList.add('winner');
            }

            if (chartInstance) {
                chartInstance.data.datasets[0].data = [totalStdCost, totalDcCost];
                chartInstance.update();
            }
        }

        window.onload = () => { initChart(); };
    </script>
</body>
</html>
